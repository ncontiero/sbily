{% extends "dashboard/base.html" %}

{% block dashboard_content %}
<div id="dashboard"></div>
<section class="py-8">
  <div class="container mx-auto px-4">
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
      <div class="bg-background rounded-lg border p-6 shadow-xs">
        <div class="flex items-center gap-4">
          <div class="bg-primary/10 flex size-12 items-center justify-center rounded-full">
            <i data-lucide="link" class="text-primary size-6"></i>
          </div>
          <div>
            <p class="text-muted-foreground text-sm">Total Links</p>
            <h2 class="text-2xl font-bold">{{ links_count }}</h2>
          </div>
        </div>
        <div class="mt-4 border-t pt-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <div class="size-3 rounded-full bg-green-500"></div>
              <span class="text-sm">Active: {{ active_links }}</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="size-3 rounded-full bg-red-500"></div>
              <span class="text-sm">Expired: {{ expired_links }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-background rounded-lg border p-6 shadow-xs">
        <div class="flex items-center gap-4">
          <div class="bg-primary/10 flex size-12 items-center justify-center rounded-full">
            <i data-lucide="mouse-pointer-click" class="text-primary size-6"></i>
          </div>
          <div>
            <p class="text-muted-foreground text-sm">Total Clicks</p>
            <h2 class="text-2xl font-bold">{{ total_clicks }}</h2>
          </div>
        </div>
        <div class="mt-4 border-t pt-4">
          <p class="text-muted-foreground text-sm">Across all your links</p>
        </div>
      </div>

      <div class="bg-background rounded-lg border p-6 shadow-xs">
        <div class="flex items-center gap-4">
          <div class="bg-primary/10 flex size-12 items-center justify-center rounded-full">
            <i data-lucide="mouse-pointer-click" class="text-primary size-6"></i>
          </div>
          <div>
            <p class="text-muted-foreground text-sm">Unique Visitor</p>
            <h2 class="text-2xl font-bold">{{ unique_visitors }}</h2>
          </div>
        </div>
        <div class="mt-4 border-t pt-4">
          <p class="text-muted-foreground text-sm">Across all your links</p>
        </div>
      </div>

      <div class="bg-background rounded-lg border p-6 shadow-xs">
        <div class="flex items-center gap-4">
          <div class="bg-primary/10 flex size-12 items-center justify-center rounded-full">
            <i data-lucide="infinity" class="text-primary size-6"></i>
          </div>
          <div>
            <p class="text-muted-foreground text-sm">Links Limit</p>
            <h2 class="text-2xl font-bold">{{ user.monthly_limit_links_used }} / {{ user.monthly_link_limit }}</h2>
          </div>
        </div>
        <div class="mt-4 border-t pt-4">
          <div class="bg-muted h-2 w-full rounded-full">
            <div
              class="bg-primary h-2 rounded-full"
              style="width: {% widthratio user.monthly_limit_links_used user.monthly_link_limit 100 %}%"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="py-6">
  <div class="container mx-auto px-4">
    <div class="bg-background rounded-lg border p-6 shadow-xs lg:col-span-2">
      <h2 class="mb-4 text-lg font-bold">Daily Clicks (Last 30 Days)</h2>
      <div class="h-64">
        <canvas id="dailyClicksChart"></canvas>
      </div>
    </div>
  </div>
</section>

{% if perms.links.view_advanced_statistics %}
<section class="py-6">
  <div class="container mx-auto px-4">
    <div class="bg-background rounded-lg border p-6 shadow-xs">
      <h2 class="mb-8 text-lg font-bold md:mb-4">Top Countries</h2>
      <div class="flex h-fit justify-center lg:h-96">
        <canvas id="countriesChart"></canvas>
      </div>
      <div class="mt-10 rounded-md border pt-6">
        <h3 class="mb-4 px-4 font-bold">Top Countries Clicks</h3>
        <div class="max-h-[500px] w-full overflow-auto overscroll-contain">
          <table class="w-full border-t text-sm">
            <thead>
              <tr class="bg-muted/30 border-b duration-200 hover:bg-muted/50">
                <th class="h-12 w-1/2 border-r-2 px-4 text-start align-middle font-bold">
                  Country
                </th>
                <th class="h-12 w-1/2 px-4 text-end align-middle font-bold">Clicks</th>
              </tr>
            </thead>
            <tbody>
              {% for item in country_distribution %}
              <tr class="hover:bg-muted/50 border-b duration-200">
                <td class="border-r-2 p-4 text-start align-middle">
                  {{ item.country }}
                </td>
                <td class="p-4 text-end align-middle">
                  {{ item.count }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<section id="links" class="py-6">
  <div class="container mx-auto px-4">
    <div class="bg-background overflow-hidden rounded-lg border shadow-xs">
      <div class="border-b p-6">
        <div class="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
          <h2 class="text-lg font-bold">Latest links</h2>
          <div class="flex gap-1.5 sm:gap-3">
            <a class="button-outline button-sm" href="{% url 'links' %}">
              View All Links
            </a>
            <button
              type="button"
              data-jswc-dialog
              data-jswc-target="create-link-dialog"
              class="button-primary button-sm gap-2"
            >
              <i data-lucide="plus" class="size-4"></i>
              New Link
            </button>
          </div>
        </div>
      </div>

      <div class="p-6">
        {% include "partials/links_table.html" with links=latest_links hash='links' %}
      </div>
    </div>
  </div>
</section>

<section class="py-6">
  <div class="container mx-auto px-4">
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
      <div class="bg-background rounded-lg border p-6 shadow-xs">
        <h2 class="mb-4 text-lg font-bold">Top Performing Links</h2>
        <div class="space-y-4">
          {% for link in top_links %}
          <div class="flex flex-col justify-between border-b pb-4 last:border-0 sm:flex-row sm:items-center">
            <div class="flex items-center gap-1.5 sm:gap-3">
              <div class="bg-primary/10 flex size-8 shrink-0 items-center justify-center rounded-full">
                <i data-lucide="link" class="text-primary size-4"></i>
              </div>
              <div class="truncate">
                <a class="font-medium hover:underline" href="{{ link.get_absolute_url }}" target="_blank">
                  {{ link.shortened_path }}
                </a>
                <div class="max-w-96 overflow-x-auto overscroll-contain pb-2">
                  <p class="text-muted-foreground text-sm">{{ link.destination_url }}</p>
                </div>
              </div>
            </div>
            <div class="badge-default mt-2 self-end sm:mt-0 sm:self-auto">{{ link.click_count }} clicks</div>
          </div>
          {% empty %}
          <div class="text-muted-foreground py-4 text-center">
            <p>No click data available yet.</p>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="bg-background rounded-lg border p-6 shadow-xs">
        <h2 class="mb-4 text-lg font-bold">Most Active Links (Last 7 Days)</h2>
        <div class="space-y-4">
          {% for link in active_links_data %}
          <div class="flex flex-col justify-between border-b pb-4 last:border-0 sm:flex-row sm:items-center">
            <div class="flex items-center gap-1.5 sm:gap-3">
              <div class="bg-primary/10 flex size-8 shrink-0 items-center justify-center rounded-full">
                <i data-lucide="activity" class="text-primary size-4"></i>
              </div>
              <div class="truncate">
                <a class="font-medium hover:underline" href="{{ link.get_absolute_url }}" target="_blank">
                  {{ link.shortened_path }}
                </a>
                <div class="max-w-96 overflow-x-auto overscroll-contain pb-2">
                  <p class="text-muted-foreground text-sm">{{ link.destination_url }}</p>
                </div>
              </div>
            </div>
            <div class="badge-secondary mt-2 self-end sm:mt-0 sm:self-auto">{{ link.recent_clicks }} clicks</div>
          </div>
          {% empty %}
          <div class="text-muted-foreground py-4 text-center">
            <p>No recent activity data available.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock dashboard_content %}

{% block js %}
<script>
  const dailyClicksData = {{ daily_clicks_data|safe }};
  {% if perms.links.view_advanced_statistics %}
  const countryLabels = [
    {% for item in country_distribution %}
      '{{ item.country|default:"Unknown" }}',
    {% endfor %}
  ];
  const countryData = [
    {% for item in country_distribution %}
      {{ item.count }},
    {% endfor %}
  ];
  {% endif %}
</script>
{% endblock js %}
